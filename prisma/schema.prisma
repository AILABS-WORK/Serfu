// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
}

model RawMessage {
  id               Int      @id @default(autoincrement())
  chatId           BigInt   @map("chat_id")
  messageId        Int      @map("message_id")
  senderId         BigInt?  @map("sender_id")
  senderUsername   String?  @map("sender_username")
  sentAt           DateTime @map("sent_at")
  rawText          String   @map("raw_text")
  parsedTemplateId String?  @map("parsed_template_id")
  isSignal         Boolean  @default(false) @map("is_signal")
  parseConfidence  Float?   @map("parse_confidence")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations (using Int foreign keys)
  groupId Int?   @map("group_id")
  userId  Int?   @map("user_id")
  group   Group? @relation(fields: [groupId], references: [id])
  user    User?  @relation(fields: [userId], references: [id])

  @@unique([chatId, messageId])
  @@index([chatId])
  @@index([senderId])
  @@index([groupId])
  @@index([userId])
  @@map("raw_messages")
}

model Signal {
  id                Int      @id @default(autoincrement())
  chatId            BigInt   @map("chat_id")
  messageId         Int      @map("message_id") // Origin message
  senderId          BigInt?  @map("sender_id") // Telegram user ID
  category          String?
  chain             String   @default("solana")
  mint              String
  name              String?
  symbol            String?
  reportedMcapText  String?  @map("reported_mcap_text")
  reportedPriceText String?  @map("reported_price_text")
  detectedAt        DateTime @default(now()) @map("detected_at")

  entryPrice         Float?    @map("entry_price")
  entryPriceAt       DateTime? @map("entry_price_at")
  entryPriceProvider String?   @default("helius") @map("entry_price_provider")
  entryMarketCap     Float?    @map("entry_market_cap")
  entrySupply        Float?    @map("entry_supply")
  tokenCreatedAt     DateTime? @map("token_created_at")

  trackingStatus TrackingStatus @default(ACTIVE) @map("tracking_status")
  trackingEndAt  DateTime?      @map("tracking_end_at")

  // Enrichment Flags
  dexPaid  Boolean @default(false) @map("dex_paid")
  migrated Boolean @default(false)
  socials  Json? // { twitter: boolean, telegram: boolean, website: boolean }

  // Relations (using Int foreign keys)
  groupId          Int?              @map("group_id")
  userId           Int?              @map("user_id")
  group            Group?            @relation(fields: [groupId], references: [id])
  user             User?             @relation(fields: [userId], references: [id])
  priceSamples     PriceSample[]
  thresholdEvents  ThresholdEvent[]
  metrics          SignalMetric?
  forwardedSignals ForwardedSignal[]
  topHolders       SignalTopHolder[]
  watchlistItems   Watchlist[]

  @@unique([chatId, messageId])
  @@index([mint])
  @@index([trackingStatus])
  @@index([chatId])
  @@index([senderId])
  @@index([groupId])
  @@index([userId])
  @@index([detectedAt]) // Optimize time-based queries for live signals, recent calls, leaderboards
  @@map("signals")
}

enum TrackingStatus {
  ACTIVE
  ARCHIVED
  ENTRY_PENDING
}

model PriceSample {
  id         BigInt   @id @default(autoincrement())
  signalId   Int      @map("signal_id")
  mint       String
  price      Float
  marketCap  Float?   @map("market_cap") // Market cap at sample time
  sampledAt  DateTime @default(now()) @map("sampled_at")
  provider   String   @default("helius")
  liquidity  Float?
  volume     Float?
  confidence Float?

  signal Signal @relation(fields: [signalId], references: [id])

  @@index([signalId, sampledAt])
  @@map("price_samples")
}

model ThresholdEvent {
  id                Int      @id @default(autoincrement())
  signalId          Int      @map("signal_id")
  multipleThreshold Int      @map("multiple_threshold") // 2, 3, 4, 5, 10
  hitPrice          Float    @map("hit_price")
  hitMarketCap      Float?   @map("hit_market_cap") // Market cap when threshold hit
  hitAt             DateTime @map("hit_at")
  provider          String   @default("helius")

  signal Signal @relation(fields: [signalId], references: [id])

  @@unique([signalId, multipleThreshold])
  @@map("threshold_events")
}

model SignalMetric {
  signalId         Int      @id @map("signal_id")
  currentPrice     Float    @map("current_price")
  currentMarketCap Float?   @map("current_market_cap") // Current market cap
  currentMultiple  Float    @map("current_multiple") // Based on market cap
  athPrice         Float    @map("ath_price")
  athMarketCap     Float?   @map("ath_market_cap") // ATH market cap
  athMultiple      Float    @map("ath_multiple") // Based on market cap
  athAt            DateTime @map("ath_at")
  timeToAth        Int?     @map("time_to_ath") // ms to reach ATH
  timeTo2x         Int?     @map("time_to_2x") // ms to reach 2x
  timeTo3x         Int?     @map("time_to_3x") // ms to reach 3x
  timeTo5x         Int?     @map("time_to_5x") // ms to reach 5x
  timeTo10x        Int?     @map("time_to_10x") // ms to reach 10x
  maxDrawdown      Float    @default(0) @map("max_drawdown") // negative % (market cap based)
  maxDrawdownMarketCap Float? @map("max_drawdown_market_cap") // Market cap at max drawdown
  timeFromDrawdownToAth Int?  @map("time_from_drawdown_to_ath") // ms from max drawdown to ATH
  stagnationTime   Int?     @map("stagnation_time") // ms spent < 1.1x before pumping
  drawdownDuration Int?     @map("drawdown_duration") // ms spent underwater before ATH
  updatedAt        DateTime @default(now()) @map("updated_at")

  signal Signal @relation(fields: [signalId], references: [id])

  @@index([updatedAt]) // Optimize stale metric checks
  @@map("signal_metrics")
}

model CategoryMetric {
  id             Int      @id @default(autoincrement())
  category       String
  window         String // 7D, 30D, ALL
  signalCount    Int      @map("signal_count")
  hit2Rate       Float    @map("hit2_rate")
  hit3Rate       Float    @map("hit3_rate")
  hit5Rate       Float    @map("hit5_rate")
  medianAth      Float    @map("median_ath")
  p75Ath         Float    @map("p75_ath")
  medianDrawdown Float    @map("median_drawdown")
  medianTimeTo2x Float?   @map("median_time_to_2x") // seconds
  updatedAt      DateTime @default(now()) @map("updated_at")

  @@unique([category, window])
  @@map("category_metrics")
}

model Group {
  id                Int      @id @default(autoincrement())
  chatId            BigInt   @map("chat_id")
  name              String?
  type              String? // "source" or "destination"
  chatType          String?  @map("chat_type") // "group", "supergroup", "channel"
  isActive          Boolean  @default(true) @map("is_active")
  autoDeleteSeconds Int?     @map("auto_delete_seconds")
  showHideButton    Boolean  @default(true) @map("show_hide_button")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // User ownership - each group belongs to a user (nullable for migration compatibility)
  ownerId Int?  @map("owner_id")
  owner   User? @relation("OwnedGroups", fields: [ownerId], references: [id])

  // Relations
  signals      Signal[]
  rawMessages  RawMessage[]
  groupMetrics GroupMetric[]

  @@unique([chatId, ownerId]) // Same group can be added by multiple users, but each user has their own record
  @@index([chatId])
  @@index([ownerId])
  @@index([chatType])
  @@map("groups")
}

model User {
  id        Int      @id @default(autoincrement())
  userId    BigInt   @unique @map("user_id")
  username  String?
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  signals              Signal[]
  rawMessages          RawMessage[]
  userMetrics          UserMetric[]
  ownedGroups          Group[]                   @relation("OwnedGroups") // Groups this user owns/manages
  notificationSettings UserNotificationSettings? @relation("NotificationSettings")
  settings             UserSettings?            @relation("UserSettings")
  watchlist            Watchlist[]
  strategyPresets      StrategyPreset[]

  @@index([userId])
  @@map("users")
}

model UserSettings {
  id              Int     @id @default(autoincrement())
  userId          Int     @unique @map("user_id")
  preferredChain  String  @default("both")
  showRiskScores  Boolean @default(true)
  showSmartAlerts Boolean @default(true)
  compactMode     Boolean @default(false)

  user User @relation(fields: [userId], references: [id], name: "UserSettings")

  @@map("user_settings")
}

model StrategyPreset {
  id         Int      @id @default(autoincrement())
  ownerId    Int      @map("owner_id")
  owner      User     @relation(fields: [ownerId], references: [id])
  targetType String   @map("target_type") // OVERALL, GROUP, USER
  targetId   Int?     @map("target_id")
  timeframe  String
  schedule   Json? // { days: ['Mon'..], windows: [{start,end}], timezone: 'UTC' }
  conditions Json? // { minVolume, minMentions, minMarketCap, maxMarketCap }
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([ownerId])
  @@index([targetType, targetId])
  @@map("strategy_presets")
}

model GroupMetric {
  id             Int      @id @default(autoincrement())
  groupId        Int      @map("group_id")
  window         String // 7D, 30D, ALL
  signalCount    Int      @map("signal_count")
  hit2Rate       Float    @map("hit2_rate")
  hit3Rate       Float    @map("hit3_rate")
  hit5Rate       Float    @map("hit5_rate")
  hit10Rate      Float    @map("hit10_rate")
  medianAth      Float    @map("median_ath")
  p75Ath         Float    @map("p75_ath")
  p90Ath         Float    @map("p90_ath")
  medianDrawdown Float    @map("median_drawdown")
  medianTimeTo2x Float?   @map("median_time_to_2x")
  avgWinRate     Float    @map("avg_win_rate")
  totalSignals   Int      @map("total_signals")
  updatedAt      DateTime @default(now()) @map("updated_at")

  group Group @relation(fields: [groupId], references: [id])

  @@unique([groupId, window])
  @@index([groupId])
  @@map("group_metrics")
}

model UserMetric {
  id               Int      @id @default(autoincrement())
  userId           Int      @map("user_id")
  window           String // 7D, 30D, ALL
  signalCount      Int      @map("signal_count")
  hit2Rate         Float    @map("hit2_rate")
  hit3Rate         Float    @map("hit3_rate")
  hit5Rate         Float    @map("hit5_rate")
  hit10Rate        Float    @map("hit10_rate")
  medianAth        Float    @map("median_ath")
  p75Ath           Float    @map("p75_ath")
  p90Ath           Float    @map("p90_ath")
  medianDrawdown   Float    @map("median_drawdown")
  medianTimeTo2x   Float?   @map("median_time_to_2x")
  avgWinRate       Float    @map("avg_win_rate")
  totalSignals     Int      @map("total_signals")
  consistencyScore Float?   @map("consistency_score") // 0-1
  riskScore        Float?   @map("risk_score") // 0-1
  updatedAt        DateTime @default(now()) @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, window])
  @@index([userId])
  @@map("user_metrics")
}

model ForwardedSignal {
  id            Int      @id @default(autoincrement())
  signalId      Int      @map("signal_id")
  sourceGroupId BigInt   @map("source_group_id")
  destGroupId   BigInt   @map("dest_group_id")
  forwardedAt   DateTime @default(now()) @map("forwarded_at")
  forwardedBy   BigInt?  @map("forwarded_by") // User who configured forwarding

  signal Signal @relation(fields: [signalId], references: [id])

  @@unique([signalId, destGroupId])
  @@index([sourceGroupId])
  @@index([destGroupId])
  @@map("forwarded_signals")
}

model CopyTradingStrategy {
  id               Int      @id @default(autoincrement())
  strategyType     String   @map("strategy_type") // "user" or "group"
  targetId         Int      @map("target_id") // User ID or Group ID
  window           String // 7D, 30D, ALL
  expectedReturn   Float    @map("expected_return")
  winRate          Float    @map("win_rate")
  riskScore        Float    @map("risk_score")
  consistencyScore Float    @map("consistency_score")
  recommendation   String // "STRONG_BUY", "BUY", "NEUTRAL", "AVOID"
  updatedAt        DateTime @default(now()) @map("updated_at")

  @@unique([strategyType, targetId, window])
  @@index([strategyType, targetId])
  @@map("copy_trading_strategies")
}

model UserNotificationSettings {
  id     Int  @id @default(autoincrement())
  userId Int  @unique @map("user_id")
  user   User @relation("NotificationSettings", fields: [userId], references: [id])

  // Threshold alerts (multiples of entry price/mcap)
  alert2x   Boolean @default(true) @map("alert_2x")
  alert3x   Boolean @default(true) @map("alert_3x")
  alert4x   Boolean @default(true) @map("alert_4x")
  alert5x   Boolean @default(true) @map("alert_5x")
  alert10x  Boolean @default(true) @map("alert_10x")
  alert15x  Boolean @default(false) @map("alert_15x")
  alert20x  Boolean @default(false) @map("alert_20x")
  alert30x  Boolean @default(false) @map("alert_30x")
  alert50x  Boolean @default(false) @map("alert_50x")
  alert100x Boolean @default(false) @map("alert_100x")

  // Event alerts
  alertDexPayment Boolean @default(true) @map("alert_dex_payment")
  alertBonding    Boolean @default(true) @map("alert_bonding")
  alertMigrating  Boolean @default(true) @map("alert_migrating")
  alertNewSignal  Boolean @default(true) @map("alert_new_signal")

  // MC multiplier alerts
  alertMc2x   Boolean @default(true) @map("alert_mc_2x")
  alertMc3x   Boolean @default(true) @map("alert_mc_3x")
  alertMc4x   Boolean @default(true) @map("alert_mc_4x")
  alertMc5x   Boolean @default(true) @map("alert_mc_5x")
  alertMc10x  Boolean @default(true) @map("alert_mc_10x")
  alertMc15x  Boolean @default(false) @map("alert_mc_15x")
  alertMc20x  Boolean @default(false) @map("alert_mc_20x")
  alertMc30x  Boolean @default(false) @map("alert_mc_30x")
  alertMc50x  Boolean @default(false) @map("alert_mc_50x")
  alertMc100x Boolean @default(false) @map("alert_mc_100x")

  // Notification channels
  notifyInGroup       Boolean @default(true) @map("notify_in_group")
  notifyInDM          Boolean @default(false) @map("notify_in_dm")
  notifyDestination   Boolean @default(true) @map("notify_destination")
  notifyHomeOnFirstCa Boolean @default(true) @map("notify_home_first_ca")
  notifyHomeOnRepost  Boolean @default(true) @map("notify_home_repost")
  homeChatId          BigInt? @map("home_chat_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("user_notification_settings")
}

// --- New Models for Top Holders ---

model TokenHolder {
  id        Int      @id @default(autoincrement())
  address   String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  signals SignalTopHolder[]

  @@map("token_holders")
}

model SignalTopHolder {
  id         Int   @id @default(autoincrement())
  signalId   Int   @map("signal_id")
  holderId   Int   @map("holder_id")
  rank       Int // 1-10
  percentage Float // Percentage of supply held (0-100)
  amount     Float // Raw token amount held

  signal Signal      @relation(fields: [signalId], references: [id])
  holder TokenHolder @relation(fields: [holderId], references: [id])

  @@unique([signalId, holderId]) // A holder appears once per signal
  @@index([holderId]) // Fast lookup: "Which other signals did this holder hold?"
  @@map("signal_top_holders")
}

model Watchlist {
  id       Int      @id @default(autoincrement())
  userId   Int      @map("user_id")
  signalId Int      @map("signal_id")
  addedAt  DateTime @default(now()) @map("added_at")

  user   User   @relation(fields: [userId], references: [id])
  signal Signal @relation(fields: [signalId], references: [id])

  @@unique([userId, signalId])
  @@index([userId])
  @@map("watchlists")
}
